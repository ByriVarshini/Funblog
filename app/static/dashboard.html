<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blog Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/styles2.css">
</head>
<body>
    <div class="d-flex" id="wrapper">
        <!-- Sidebar -->
        <div class="bg-white border-end" id="sidebar-wrapper">
            <div class="sidebar-heading text-primary fw-bold fs-4 p-3">My Dashboard</div>
            <div class="list-group list-group-flush">
                <a href="/static/dashboard.html" class="list-group-item list-group-item-action">ğŸ  Dashboard</a>
                <a href="/static/myposts.html" class="list-group-item list-group-item-action">ğŸ“ My Posts</a>
                <a href="/static/myfeed.html" class="list-group-item list-group-item-action">ğŸ  My feed</a>
                <a href="#" class="list-group-item list-group-item-action">ğŸ“‚ Drafts</a>
                <a href="/static/createpost.html" class="list-group-item list-group-item-action">â• Create Post</a>
                <a href="#" class="list-group-item list-group-item-action">âš™ï¸ Settings</a>
                <a href="#" class="list-group-item list-group-item-action text-danger">ğŸšª Logout</a>
            </div>

        </div>

        <!-- Page Content -->
        <div id="page-content-wrapper" class="p-4 w-100">
            <nav class="navbar navbar-light bg-white shadow-sm px-4 mb-4">
                <h4 class="mb-0">Welcome Back, <span id="username" class="text-primary fw-bold">Loading...</span>!</h4>
            </nav>
            
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", async function () {
            let token = localStorage.getItem("token");
        
            if (!token) {
                alert("Unauthorized! Please login first.");
                window.location.href = "/";
                return;
            }
        
            async function fetchUserDetails() {
                try {
                    let response = await fetch("http://127.0.0.1:8000/auth/me", {
                        method: "GET",
                        headers: {
                            "Authorization": `Bearer ${token}`,
                            "Content-Type": "application/json"
                        }
                    });
        
                    let user = await response.json();
                    if (!response.ok) throw new Error(user.detail || "Failed to fetch user details.");
        
                    document.getElementById("username").innerText = user.username;
                    return user.username;
                } catch (error) {
                    console.error(error);
                    alert("Session expired! Please log in again.");
                    localStorage.removeItem("token");
                    window.location.href = "/";
                }
            }
        
            async function fetchUserPosts() {
                try {
                    let postTable = document.getElementById("myposts-table");
                    if (!postTable) {
                        console.error("Error: 'myposts-table' element not found!");
                        return;  // Exit the function if table is missing
                    }
            
                    let response = await fetch(`http://127.0.0.1:8000/posts/myposts`, {
                        method: "GET",
                        headers: {
                            "Authorization": `Bearer ${token}`,
                            "Content-Type": "application/json"
                        }
                    });
            
                    let result = await response.json();
                    if (!response.ok) throw new Error(result.detail || "Failed to fetch posts.");
            
                    postTable.innerHTML = "";  // Clear existing content
            
                    result.my_posts.forEach(post => {
                        let row = `
                            <tr>
                                <td>${post.title}</td>
                                <td>${new Date(post.created_at).toLocaleDateString()}</td>
                                <td>${post.published ? "Published" : "Draft"}</td>
                                <td>${post.views || 0}</td>
                                <td>
                                    <button class="btn btn-warning btn-sm edit-btn" data-id="${post.post_id}">Edit</button>
                                    <button class="btn btn-danger btn-sm delete-btn" data-id="${post.post_id}">Delete</button>
                                </td>
                            </tr>
                        `;
                        postTable.innerHTML += row;
                    });
            
                } catch (error) {
                    console.error("Error fetching posts:", error);
                    alert("Error fetching posts! See console for details.");
                }
            }
            let username = await fetchUserDetails();
            if (username) {
                await fetchUserPosts(username);
            }
        });
        
    </script>
</body>
</html>